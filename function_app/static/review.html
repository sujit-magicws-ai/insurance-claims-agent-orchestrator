<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manual Claim Damage Estimate</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f5f5f5; }
        .review-container { max-width: 900px; margin: 20px auto; }
        .card { margin-bottom: 20px; }
        .card-header { font-weight: 600; }
        .form-label { font-weight: 500; }
        .btn-approve { background-color: #28a745; border-color: #28a745; }
        .btn-reject { background-color: #dc3545; border-color: #dc3545; }
        .loading { text-align: center; padding: 50px; }
        .error-message { color: #dc3545; }
        .success-message { color: #28a745; }
        #statusMessage { margin-top: 20px; padding: 15px; border-radius: 5px; display: none; }

        /* Page Header */
        .page-header {
            background: linear-gradient(135deg, #1a237e 0%, #3949ab 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }
        .page-header h2 { margin: 0; }
        .claim-id-badge { font-size: 1.1rem; opacity: 0.9; }

        /* Timeline Styles */
        .timeline-section {
            background: white;
            border-radius: 8px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .timeline-section h5 {
            color: #1a237e;
            border-bottom: 2px solid #1a237e;
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }
        .timeline-horizontal {
            display: flex;
            justify-content: space-between;
            position: relative;
            padding: 0 10px;
        }
        .timeline-horizontal::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 40px;
            right: 40px;
            height: 3px;
            background: #dee2e6;
        }
        .timeline-stage {
            text-align: center;
            position: relative;
            z-index: 1;
            flex: 1;
        }
        .timeline-dot {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #dee2e6;
            margin: 0 auto 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: white;
        }
        .timeline-dot.completed { background: #4CAF50; }
        .timeline-dot.active { background: #FF9800; animation: pulse 2s infinite; }
        .timeline-dot.pending { background: #dee2e6; }
        .timeline-label { font-size: 0.8rem; font-weight: 500; color: #333; }
        .timeline-time { font-size: 0.7rem; color: #666; }
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(255, 152, 0, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(255, 152, 0, 0); }
        }

        /* Classifier Decision Section */
        .classifier-section {
            background: white;
            border-radius: 8px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid #1a237e;
        }
        .classifier-section h5 {
            color: #1a237e;
            margin-bottom: 1rem;
        }
        .classification-badges {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }
        .classification-badge {
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        .badge-type { background: #e3f2fd; color: #1565c0; }
        .badge-subtype { background: #f3e5f5; color: #7b1fa2; }
        .badge-component { background: #fff3e0; color: #ef6c00; }

        /* Confidence Bar */
        .confidence-container { margin-bottom: 1rem; }
        .confidence-label { font-size: 0.85rem; color: #666; margin-bottom: 0.25rem; }
        .confidence-bar {
            height: 24px;
            background: #e0e0e0;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }
        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50 0%, #8BC34A 100%);
            border-radius: 12px;
            transition: width 0.5s ease;
        }
        .confidence-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: bold;
            font-size: 0.85rem;
            color: #333;
        }

        /* Justification & Document */
        .info-box {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .info-box-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: #666;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        .info-box-content { color: #333; line-height: 1.5; }

        /* Flags */
        .flags-section { margin-top: 1rem; }
        .flag-item {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .flag-success { background: #e8f5e9; color: #2e7d32; }
        .flag-warning { background: #fff3e0; color: #ef6c00; }
        .flag-info { background: #e3f2fd; color: #1565c0; }

        /* Section Divider */
        .section-title {
            font-size: 0.9rem;
            text-transform: uppercase;
            color: #666;
            letter-spacing: 1px;
            margin: 1.5rem 0 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #dee2e6;
        }
    </style>
</head>
<body>
    <div class="review-container">
        <!-- Loading State -->
        <div id="loadingState" class="loading">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Loading claim data...</p>
        </div>

        <!-- Error State -->
        <div id="errorState" class="alert alert-danger" style="display: none;">
            <h5>Error Loading Claim</h5>
            <p id="errorMessage"></p>
        </div>

        <!-- Review Form -->
        <div id="reviewForm" style="display: none;">
            <!-- Page Header -->
            <div class="page-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2>Manual Claim Damage Estimate</h2>
                        <span class="claim-id-badge">Claim: <strong id="headerClaimId">-</strong></span>
                    </div>
                    <span class="badge bg-warning fs-6" id="headerStatus">Awaiting Estimate</span>
                </div>
            </div>

            <!-- Workflow Timeline -->
            <div class="timeline-section">
                <h5>Workflow Timeline</h5>
                <div class="timeline-horizontal" id="timelineContainer">
                    <!-- Timeline will be populated by JS -->
                </div>
            </div>

            <!-- Classifier Agent Decision -->
            <div class="classifier-section">
                <h5>Claim Classifier Agent Decision</h5>

                <!-- Classification Badges -->
                <div class="classification-badges">
                    <span class="classification-badge badge-type" id="badgeClaimType">-</span>
                    <span class="classification-badge badge-subtype" id="badgeSubType">-</span>
                    <span class="classification-badge badge-component" id="badgeComponent">-</span>
                </div>

                <!-- Confidence Bar -->
                <div class="confidence-container">
                    <div class="confidence-label">Confidence Score</div>
                    <div class="confidence-bar">
                        <div class="confidence-fill" id="confidenceFill" style="width: 0%"></div>
                        <span class="confidence-text" id="confidenceText">-</span>
                    </div>
                </div>

                <!-- Justification -->
                <div class="info-box">
                    <div class="info-box-label">Justification</div>
                    <div class="info-box-content" id="justificationText">-</div>
                </div>

                <!-- Document Extraction -->
                <div class="info-box" id="documentExtractionBox">
                    <div class="info-box-label">Document Extraction</div>
                    <div class="info-box-content">
                        <span id="docExtractionStatus" class="badge bg-success me-2">-</span>
                        <span id="docExtractionSummary">-</span>
                    </div>
                </div>

                <!-- Flags -->
                <div class="flags-section" id="flagsSection">
                    <!-- Flags will be populated by JS -->
                </div>
            </div>

            <!-- Section Title for Form -->
            <div class="section-title">Claim Data Entry</div>

            <form id="claimForm">
                <!-- Claimant Information -->
                <div class="card">
                    <div class="card-header bg-primary text-white">Claimant Information</div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label for="claimantName" class="form-label">Name</label>
                                <input type="text" class="form-control" id="claimantName" name="claimant.name">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="claimantEmail" class="form-label">Email</label>
                                <input type="email" class="form-control" id="claimantEmail" name="claimant.email">
                            </div>
                            <div class="col-md-2 mb-3">
                                <label for="claimantPhone" class="form-label">Phone</label>
                                <input type="tel" class="form-control" id="claimantPhone" name="claimant.phone">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="claimantAddress" class="form-label">Address</label>
                                <input type="text" class="form-control" id="claimantAddress" name="claimant.address">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contract Information -->
                <div class="card">
                    <div class="card-header bg-primary text-white">Contract Information</div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="contractNumber" class="form-label">Contract Number</label>
                                <input type="text" class="form-control" id="contractNumber" name="contract.contract_number">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="productType" class="form-label">Product Type</label>
                                <select class="form-select" id="productType" name="contract.product_type">
                                    <option value="VSC">VSC (Vehicle Service Contract)</option>
                                    <option value="GAP">GAP (Total Loss Protection)</option>
                                    <option value="Tire & Wheel">Tire & Wheel / Road Hazard</option>
                                    <option value="PPM">PPM (Pre-Paid Maintenance)</option>
                                    <option value="Appearance">Appearance Protection</option>
                                    <option value="Theft">Theft Protection</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="coverageLevel" class="form-label">Coverage Level</label>
                                <select class="form-select" id="coverageLevel" name="contract.coverage_level">
                                    <option value="Bronze">Bronze</option>
                                    <option value="Silver">Silver</option>
                                    <option value="Gold">Gold</option>
                                    <option value="Platinum">Platinum</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label for="contractStatus" class="form-label">Status</label>
                                <select class="form-select" id="contractStatus" name="contract.status">
                                    <option value="Active">Active</option>
                                    <option value="Expired">Expired</option>
                                    <option value="Cancelled">Cancelled</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="effectiveDate" class="form-label">Effective Date</label>
                                <input type="date" class="form-control" id="effectiveDate" name="contract.effective_date">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="expirationDate" class="form-label">Expiration Date</label>
                                <input type="date" class="form-control" id="expirationDate" name="contract.expiration_date">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="deductible" class="form-label">Deductible ($)</label>
                                <input type="number" class="form-control" id="deductible" name="contract.deductible" min="0" step="0.01" value="100">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="maxClaimAmount" class="form-label">Max Claim Amount ($)</label>
                                <input type="number" class="form-control" id="maxClaimAmount" name="contract.max_claim_amount" min="0" step="0.01" value="5000">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="mileageLimit" class="form-label">Mileage Limit</label>
                                <input type="number" class="form-control" id="mileageLimit" name="contract.mileage_limit" min="0" value="100000">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Vehicle Information -->
                <div class="card">
                    <div class="card-header bg-primary text-white">Vehicle Information</div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-2 mb-3">
                                <label for="vehicleYear" class="form-label">Year</label>
                                <input type="number" class="form-control" id="vehicleYear" name="vehicle.year" min="1900" max="2030">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="vehicleMake" class="form-label">Make</label>
                                <input type="text" class="form-control" id="vehicleMake" name="vehicle.make">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="vehicleModel" class="form-label">Model</label>
                                <input type="text" class="form-control" id="vehicleModel" name="vehicle.model">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="vehicleVin" class="form-label">VIN</label>
                                <input type="text" class="form-control" id="vehicleVin" name="vehicle.vin" maxlength="17">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="currentMileage" class="form-label">Current Mileage</label>
                                <input type="number" class="form-control" id="currentMileage" name="vehicle.current_mileage" min="0">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="purchaseMileage" class="form-label">Purchase Mileage</label>
                                <input type="number" class="form-control" id="purchaseMileage" name="vehicle.purchase_mileage" min="0">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Repair Information -->
                <div class="card">
                    <div class="card-header bg-primary text-white">Repair Information</div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="facilityName" class="form-label">Facility Name</label>
                                <input type="text" class="form-control" id="facilityName" name="repair.facility_name">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="facilityType" class="form-label">Facility Type</label>
                                <select class="form-select" id="facilityType" name="repair.facility_type">
                                    <option value="Authorized Dealer">Authorized Dealer</option>
                                    <option value="Independent Shop">Independent Shop</option>
                                    <option value="Chain Store">Chain Store</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="diagnosis" class="form-label">Diagnosis</label>
                                <textarea class="form-control" id="diagnosis" name="repair.diagnosis" rows="2"></textarea>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="repairType" class="form-label">Repair Type</label>
                                <input type="text" class="form-control" id="repairType" name="repair.repair_type" placeholder="e.g., Mechanical - Transmission">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="totalParts" class="form-label">Total Parts ($)</label>
                                <input type="number" class="form-control" id="totalParts" name="repair.total_parts" min="0" step="0.01" value="0">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="totalLabor" class="form-label">Total Labor ($)</label>
                                <input type="number" class="form-control" id="totalLabor" name="repair.total_labor" min="0" step="0.01" value="0">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="totalEstimate" class="form-label">Total Estimate ($)</label>
                                <input type="number" class="form-control" id="totalEstimate" name="repair.total_estimate" min="0" step="0.01" value="0">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Documents -->
                <div class="card">
                    <div class="card-header bg-primary text-white">Documents</div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="docRepairEstimate" name="documents.repair_estimate">
                                    <label class="form-check-label" for="docRepairEstimate">Repair Estimate</label>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="docDiagnosticReport" name="documents.diagnostic_report">
                                    <label class="form-check-label" for="docDiagnosticReport">Diagnostic Report</label>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="docPhotos" name="documents.photos">
                                    <label class="form-check-label" for="docPhotos">Photos</label>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="docPriorAuth" name="documents.prior_authorization">
                                    <label class="form-check-label" for="docPriorAuth">Prior Authorization</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Submit Estimate -->
                <div class="card">
                    <div class="card-header bg-primary text-white">Submit Estimate</div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="reviewerEmail" class="form-label">Submitted By (Email) *</label>
                                <input type="email" class="form-control" id="reviewerEmail" required placeholder="your.email@company.com">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="reviewerComments" class="form-label">Notes (Optional)</label>
                                <textarea class="form-control" id="reviewerComments" rows="2" placeholder="Any additional notes for the adjudicator..."></textarea>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <button type="button" class="btn btn-primary btn-lg" onclick="submitEstimate()">
                                    Submit Estimate for Adjudication
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </form>

            <!-- Status Message -->
            <div id="statusMessage"></div>
        </div>
    </div>

    <script>
        // Get instance_id from URL
        const pathParts = window.location.pathname.split('/');
        const instanceId = pathParts[pathParts.length - 1];
        let claimData = null;

        // Load claim data on page load
        document.addEventListener('DOMContentLoaded', loadClaimData);

        async function loadClaimData() {
            try {
                const response = await fetch(`/api/claims/status/${instanceId}`);
                const data = await response.json();

                if (!response.ok) {
                    showError(data.message || 'Failed to load claim data');
                    return;
                }

                if (data.custom_status?.step !== 'awaiting_approval') {
                    showError(`Claim is not awaiting approval. Current status: ${data.custom_status?.step || data.runtime_status}`);
                    return;
                }

                claimData = data;
                populateForm(data);
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('reviewForm').style.display = 'block';

            } catch (error) {
                showError('Error loading claim data: ' + error.message);
            }
        }

        function populateForm(data) {
            const agent1Output = data.custom_status?.agent1_output || {};
            const classification = agent1Output.classification || {};
            // extracted_info now contains merged data from email + document
            const extractedInfo = agent1Output.extracted_info || {};
            const docExtraction = agent1Output.document_extraction || {};
            const flags = agent1Output.flags || {};
            const stageTimestamps = data.custom_status?.stage_timestamps || {};

            // Page Header
            document.getElementById('headerClaimId').textContent = agent1Output.claim_id || instanceId.replace('claim-', '');

            // Build Timeline
            buildTimeline(stageTimestamps);

            // Classification Badges
            document.getElementById('badgeClaimType').textContent = classification.claim_type || 'Unknown';
            document.getElementById('badgeSubType').textContent = classification.sub_type || '-';
            document.getElementById('badgeComponent').textContent = classification.component_category || '-';

            // Confidence Bar
            const confidence = agent1Output.confidence_score || 0;
            const confidencePercent = (confidence * 100).toFixed(0);
            document.getElementById('confidenceFill').style.width = confidencePercent + '%';
            document.getElementById('confidenceText').textContent = confidencePercent + '%';

            // Justification
            document.getElementById('justificationText').textContent = agent1Output.justification || 'No justification provided';

            // Document Extraction
            const docStatus = docExtraction.status || 'unknown';
            const docStatusEl = document.getElementById('docExtractionStatus');
            docStatusEl.textContent = docStatus.charAt(0).toUpperCase() + docStatus.slice(1);
            docStatusEl.className = 'badge me-2 ' + (docStatus === 'success' ? 'bg-success' : docStatus === 'failed' ? 'bg-danger' : 'bg-secondary');
            document.getElementById('docExtractionSummary').textContent = docExtraction.summary || 'No document extraction summary available';

            // Flags
            buildFlags(flags);

            // Hide document extraction box if not available
            if (!docExtraction.status) {
                document.getElementById('documentExtractionBox').style.display = 'none';
            }

            // Pre-fill form fields from merged extracted_info
            // Claimant (now directly available in extracted_info)
            setValue('claimantName', extractedInfo.claimant_name);
            setValue('claimantEmail', extractedInfo.claimant_email);
            setValue('claimantPhone', extractedInfo.claimant_phone);
            setValue('claimantAddress', extractedInfo.claimant_address);

            // Contract
            setValue('contractNumber', extractedInfo.contract_number);
            setValue('productType', classification.claim_type || 'VSC');
            setValue('coverageLevel', 'Gold');
            setValue('contractStatus', 'Active');
            setValue('deductible', 100);
            setValue('maxClaimAmount', 5000);
            setValue('mileageLimit', 100000);

            // Vehicle (now directly available in extracted_info)
            setValue('vehicleYear', extractedInfo.vehicle_year);
            setValue('vehicleMake', extractedInfo.vehicle_make);
            setValue('vehicleModel', extractedInfo.vehicle_model);
            setValue('vehicleVin', extractedInfo.vehicle_vin);
            setValue('currentMileage', '');
            setValue('purchaseMileage', '');

            // Repair
            setValue('facilityName', extractedInfo.repair_facility);
            setValue('facilityType', 'Authorized Dealer');
            setValue('diagnosis', extractedInfo.diagnosis || extractedInfo.issue_summary);
            setValue('repairType', `${classification.sub_type || 'Mechanical'} - ${classification.component_category || 'General'}`);
            setValue('totalParts', extractedInfo.total_parts || 0);
            setValue('totalLabor', extractedInfo.total_labor || 0);
            setValue('totalEstimate', extractedInfo.total_estimate || 0);

            // Documents
            setChecked('docRepairEstimate', true);
            setChecked('docDiagnosticReport', docExtraction.status === 'success');
            setChecked('docPhotos', false);
            setChecked('docPriorAuth', false);
        }

        function setValue(id, value) {
            const el = document.getElementById(id);
            if (el && value !== null && value !== undefined) {
                el.value = value;
            }
        }

        function setChecked(id, checked) {
            const el = document.getElementById(id);
            if (el) {
                el.checked = checked;
            }
        }

        function getValue(id) {
            const el = document.getElementById(id);
            return el ? el.value : '';
        }

        function getChecked(id) {
            const el = document.getElementById(id);
            return el ? el.checked : false;
        }

        function getNumericValue(id) {
            const val = getValue(id);
            return val ? parseFloat(val) : null;
        }

        function buildClaimData() {
            return {
                claimant: {
                    name: getValue('claimantName') || null,
                    email: getValue('claimantEmail') || null,
                    phone: getValue('claimantPhone') || null,
                    address: getValue('claimantAddress') || null
                },
                contract: {
                    contract_number: getValue('contractNumber') || null,
                    product_type: getValue('productType'),
                    coverage_level: getValue('coverageLevel'),
                    status: getValue('contractStatus'),
                    effective_date: getValue('effectiveDate') || null,
                    expiration_date: getValue('expirationDate') || null,
                    deductible: getNumericValue('deductible') || 0,
                    max_claim_amount: getNumericValue('maxClaimAmount') || 5000,
                    mileage_limit: getNumericValue('mileageLimit') || 100000
                },
                vehicle: {
                    year: getNumericValue('vehicleYear'),
                    make: getValue('vehicleMake') || null,
                    model: getValue('vehicleModel') || null,
                    vin: getValue('vehicleVin') || null,
                    current_mileage: getNumericValue('currentMileage'),
                    purchase_mileage: getNumericValue('purchaseMileage')
                },
                repair: {
                    facility_name: getValue('facilityName') || null,
                    facility_type: getValue('facilityType'),
                    diagnosis: getValue('diagnosis') || null,
                    repair_type: getValue('repairType') || null,
                    total_parts: getNumericValue('totalParts') || 0,
                    total_labor: getNumericValue('totalLabor') || 0,
                    total_estimate: getNumericValue('totalEstimate') || 0
                },
                documents: {
                    repair_estimate: getChecked('docRepairEstimate'),
                    diagnostic_report: getChecked('docDiagnosticReport'),
                    photos: getChecked('docPhotos'),
                    prior_authorization: getChecked('docPriorAuth')
                }
            };
        }

        async function submitEstimate() {
            const reviewerEmail = getValue('reviewerEmail');
            if (!reviewerEmail) {
                alert('Please enter your email address');
                return;
            }

            const payload = {
                reviewer: reviewerEmail,
                comments: getValue('reviewerComments'),
                claim_data: buildClaimData()
            };

            try {
                const response = await fetch(`/api/claims/approve/${instanceId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (response.ok) {
                    showStatus('Estimate submitted successfully! The Claim Adjudicator Agent will now process the claim.', 'success');
                    // Disable form after submission
                    document.querySelectorAll('input, select, textarea, button').forEach(el => el.disabled = true);
                } else {
                    showStatus(`Error: ${result.message || result.error}`, 'error');
                }
            } catch (error) {
                showStatus('Error submitting estimate: ' + error.message, 'error');
            }
        }

        function showError(message) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorState').style.display = 'block';
        }

        function showStatus(message, type) {
            const el = document.getElementById('statusMessage');
            el.textContent = message;
            el.className = type === 'success' ? 'alert alert-success' : 'alert alert-danger';
            el.style.display = 'block';
        }

        function buildTimeline(timestamps) {
            const stages = [
                { id: 'received', label: 'Received', icon: '1', timeKey: 'received' },
                { id: 'classifier', label: 'Classifier', icon: '2', timeKey: 'classifier_completed' },
                { id: 'manual', label: 'Manual Estimate', icon: '3', timeKey: 'awaiting_started' },
                { id: 'adjudicator', label: 'Adjudicator', icon: '4', timeKey: 'adjudicator_completed' },
                { id: 'complete', label: 'Complete', icon: '5', timeKey: 'completed' }
            ];

            // Current stage is "manual" (awaiting_approval)
            const stageStatus = {
                received: 'completed',
                classifier: 'completed',
                manual: 'active',
                adjudicator: 'pending',
                complete: 'pending'
            };

            const container = document.getElementById('timelineContainer');
            container.innerHTML = stages.map(stage => {
                const status = stageStatus[stage.id];
                const ts = timestamps[stage.timeKey];
                const timeStr = ts && status !== 'pending' ? formatTime(ts) : '';

                return `
                    <div class="timeline-stage">
                        <div class="timeline-dot ${status}">${status === 'completed' ? '&#10003;' : status === 'active' ? '&#9679;' : stage.icon}</div>
                        <div class="timeline-label">${stage.label}</div>
                        <div class="timeline-time">${timeStr}</div>
                    </div>
                `;
            }).join('');
        }

        function formatTime(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function buildFlags(flags) {
            const container = document.getElementById('flagsSection');
            const items = [];

            // Missing information
            if (flags.missing_information && flags.missing_information.length > 0) {
                flags.missing_information.forEach(item => {
                    items.push(`<span class="flag-item flag-warning">&#9888; Missing: ${item}</span>`);
                });
            }

            // Potential concerns
            if (flags.potential_concerns && flags.potential_concerns.length > 0) {
                flags.potential_concerns.forEach(item => {
                    items.push(`<span class="flag-item flag-warning">&#9888; ${item}</span>`);
                });
            }

            // If no issues, show all clear
            if (items.length === 0) {
                items.push(`<span class="flag-item flag-success">&#10003; No Issues Detected</span>`);
            }

            container.innerHTML = items.join('');
        }
    </script>
</body>
</html>
